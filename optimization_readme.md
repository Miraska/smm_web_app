# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ—Å—Ç–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–†–∞–Ω—å—à–µ —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞—Ä—Å–∏–ª–∞ **10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤** –∏–∑ –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –ò–∑–ª–∏—à–Ω–µ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ Telegram API
- –ú–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ—Å—É—Ä—Å–æ–≤

## –†–µ—à–µ–Ω–∏–µ

### üîç –£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤

**–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**

1. **–ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏–∑ –ë–î (–ø–æ `message_id` –∏ –¥–∞—Ç–µ)
2. **–ü–∞—Ä—Å–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤–µ–µ** –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –≤ –ë–î (`until_date` –ø–∞—Ä–∞–º–µ—Ç—Ä)
3. **–§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ message_id** - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ—Å—Ç—ã —Å `message_id <= last_message_id_in_db`
4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –≤ –ë–î –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
5. **–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ** –ø–æ—Å—Ç—ã

### üéØ –ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –ê—Å–ø–µ–∫—Ç | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|--------|------|--------|
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Å–∏–Ω–≥–∞** | –í—Å–µ–≥–¥–∞ 10 –ø–æ—Å—Ç–æ–≤ | –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** | –ü–æ –¥–∞—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω–æ | –ü–æ `message_id` –¥–ª—è –∫–∞–Ω–∞–ª–∞ |
| **API –∑–∞–ø—Ä–æ—Å—ã** | –ú–Ω–æ–≥–æ –ª–∏—à–Ω–∏—Ö | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ |
| **–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫** | –ú–µ–¥–ª–µ–Ω–Ω–æ | –ë—ã—Å—Ç—Ä–æ (0 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤) |

### üì° –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ API Endpoints

#### 1. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** (–Ω–æ–≤—ã–π)
```
POST /api/posts/check-new-optimized
```

#### 2. **–û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** (–æ–±–Ω–æ–≤–ª–µ–Ω)
```
POST /api/posts/check-new
```
*–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º*

#### 3. **–ü–∞—Ä—Å–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞** (–æ–±–Ω–æ–≤–ª–µ–Ω)
```
POST /api/sources/parse-new/{channel_id}
```
*–£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–∞–Ω–∞–ª—É*

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Å–∏–Ω–≥–∞:
- `check_limit = 20` - –ø—Ä–æ–≤–µ—Ä—è–µ–º 20 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤ –∏–∑ –∫–∞–Ω–∞–ª–∞
- `until_date` - –ø–∞—Ä—Å–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤–µ–µ –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –≤ –ë–î
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `message_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
```python
# 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç –∫–∞–Ω–∞–ª–∞ –∏–∑ –ë–î
last_post = db.query(Post).filter(
    Post.channel_id == channel_id
).order_by(Post.post_date.desc()).first()

# 2. –ü–∞—Ä—Å–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤–µ–µ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞
result = await telegram_parser.parse_channel_posts(
    channel_id, 
    limit=20,
    until_date=last_post.post_date  # –ö–ª—é—á–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è!
)

# 3. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ message_id
for post in posts_data:
    if post.message_id <= last_post.message_id:
        continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—ã–µ
```

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:**
- –ü–∞—Ä—Å–∏—Ç –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –∫–∞–∫ –æ–±—ã—á–Ω–æ
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ

**–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏:**
- –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ—Ç: **–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ** (1-2 —Å–µ–∫)
- –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ: –ø–∞—Ä—Å–∏—Ç —Ç–æ–ª—å–∫–æ –∏—Ö
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
python test_optimized_parsing.py
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
2. –ü–µ—Ä–≤—ã–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
3. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ)
4. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å frontend API

### ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ **Frontend –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ `/api/posts/check-new`
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥** –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω
- ‚úÖ **Backward compatibility** - –≤—Å–µ —Å—Ç–∞—Ä—ã–µ API —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç** `/api/posts/check-new-optimized` –¥–ª—è —è–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞

### üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥:**
- –ü–∞—Ä—Å–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã (–Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- –†–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–º–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –¥–∞—Ç–µ –∏ message_id
- –ò–∑–±–µ–≥–∞–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ª—É—á—à–µ –ø—Ä–∏ —Ä–æ—Å—Ç–µ —á–∏—Å–ª–∞ –∫–∞–Ω–∞–ª–æ–≤ 