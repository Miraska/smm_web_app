#!/bin/bash

echo "üîß –ó–∞–ø—É—Å–∫ SMM –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "uvicorn\|python.*main.py" 2>/dev/null || true

# –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ /tmp
echo "üìÅ –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ /tmp..."
mkdir -p /tmp/smm_work
chmod 777 /tmp/smm_work
cd /tmp/smm_work

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -d "smm_web_app" ]; then
    echo "üìã –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç –≤ /tmp..."
    cp -r /home/incube/Documents/smm_web_app .
    chmod -R 777 smm_web_app
fi

cd smm_web_app/backend

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –±–∞–∑—ã –∏ —Å–µ—Å—Å–∏–∏
echo "üóëÔ∏è –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ..."
rm -f /tmp/smm_app.db*
rm -rf sessions/
mkdir -p sessions
chmod 777 sessions

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å umask –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
umask 000

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ ! -d "venv" ]; then
    echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
else
    echo "üêç –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    source venv/bin/activate
fi

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DATABASE_URL="sqlite:////tmp/smm_app.db"
export PYTHONPATH="/tmp/smm_work/smm_web_app/backend"

# –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
touch /tmp/smm_app.db
chmod 666 /tmp/smm_app.db

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
echo "üìç –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: /tmp/smm_app.db"
echo "üìÅ –°–µ—Å—Å–∏–∏: $(pwd)/sessions/"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level debug 